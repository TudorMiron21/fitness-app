{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/logger.ts","../src/cloudEventsDispatcher.ts","../src/webPubSubEventHandler.ts"],"sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport { IncomingMessage } from \"http\";\n\nfunction isJsonObject(obj: any): boolean {\n  return obj && typeof obj === \"object\" && !Array.isArray(obj);\n}\n\nexport function toBase64JsonString(obj: Record<string, any>): string {\n  return Buffer.from(JSON.stringify(obj)).toString(\"base64\");\n}\n\nexport function fromBase64JsonString(base64String: string | undefined): Record<string, any> {\n  if (base64String === undefined) {\n    return {};\n  }\n\n  try {\n    const buf = Buffer.from(base64String, \"base64\").toString();\n    const parsed = JSON.parse(buf);\n    return isJsonObject(parsed) ? parsed : {};\n  } catch (e: any) {\n    console.warn(\"Unexpected state format:\" + e);\n    return {};\n  }\n}\n\nexport function getHttpHeader(req: IncomingMessage, key: string): string | undefined {\n  if (!key) return undefined;\n\n  // According to https://nodejs.org/api/http.html#http_class_http_incomingmessage, header names are always lower-cased\n  const value = req.headers[key.toLowerCase()];\n\n  if (value === undefined) {\n    return undefined;\n  }\n  if (typeof value === \"string\") {\n    return value;\n  }\n\n  return value[0];\n}\n\nexport function readRequestBody(req: IncomingMessage): Promise<Buffer> {\n  return new Promise(function (resolve, reject) {\n    const chunks: any = [];\n    req.on(\"data\", function (chunk) {\n      chunks.push(chunk);\n    });\n    req.on(\"end\", function () {\n      const buffer = Buffer.concat(chunks);\n      resolve(buffer);\n    });\n    // reject on request error\n    req.on(\"error\", function (err) {\n      // This is not a \"Second reject\", just a different sort of failure\n      reject(err);\n    });\n  });\n}\n","// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport { createClientLogger } from \"@azure/logger\";\n\n/**\n * The \\@azure/logger configuration for this package.\n *\n * @internal\n */\nexport const logger = createClientLogger(\"web-pubsub-express\");\n","// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport * as utils from \"./utils\";\nimport { IncomingMessage, ServerResponse } from \"http\";\nimport { URL } from \"url\";\nimport { logger } from \"./logger\";\n\nimport {\n  ConnectRequest,\n  ConnectResponse,\n  ConnectedRequest,\n  ConnectionContext,\n  ConnectResponseHandler,\n  DisconnectedRequest,\n  UserEventRequest,\n  UserEventResponseHandler,\n  WebPubSubEventHandlerOptions,\n} from \"./cloudEventsProtocols\";\n\nenum EventType {\n  Connect,\n  Connected,\n  Disconnected,\n  UserEvent,\n}\n\nfunction getConnectResponseHandler(\n  connectRequest: ConnectRequest,\n  response: ServerResponse\n): ConnectResponseHandler {\n  const states: Record<string, any> = connectRequest.context.states;\n  let modified = false;\n  const handler = {\n    setState(name: string, value: unknown): void {\n      states[name] = value;\n      modified = true;\n    },\n    success(res?: ConnectResponse): void {\n      response.statusCode = 200;\n      if (modified) {\n        response.setHeader(\"ce-connectionState\", utils.toBase64JsonString(states));\n      }\n      if (res === undefined) {\n        response.end();\n      } else {\n        response.setHeader(\"Content-Type\", \"application/json; charset=utf-8\");\n        response.end(JSON.stringify(res));\n      }\n    },\n    fail(code: 400 | 401 | 500, detail?: string): void {\n      response.statusCode = code;\n      response.end(detail ?? \"\");\n    },\n  };\n\n  return handler;\n}\n\nfunction getUserEventResponseHandler(\n  userRequest: UserEventRequest,\n  response: ServerResponse\n): UserEventResponseHandler {\n  const states: Record<string, any> = userRequest.context.states;\n  let modified = false;\n  const handler = {\n    setState(name: string, value: unknown): void {\n      modified = true;\n      states[name] = value;\n    },\n    success(data?: string | ArrayBuffer, dataType?: \"binary\" | \"text\" | \"json\"): void {\n      response.statusCode = 200;\n      if (modified) {\n        response.setHeader(\"ce-connectionState\", utils.toBase64JsonString(states));\n      }\n\n      switch (dataType) {\n        case \"json\":\n          response.setHeader(\"Content-Type\", \"application/json; charset=utf-8\");\n          break;\n        case \"text\":\n          response.setHeader(\"Content-Type\", \"text/plain; charset=utf-8\");\n          break;\n        default:\n          response.setHeader(\"Content-Type\", \"application/octet-stream\");\n          break;\n      }\n      response.end(data ?? \"\");\n    },\n    fail(code: 400 | 401 | 500, detail?: string): void {\n      response.statusCode = code;\n      response.end(detail ?? \"\");\n    },\n  };\n  return handler;\n}\n\nfunction getContext(request: IncomingMessage, origin: string): ConnectionContext {\n  const context = {\n    signature: utils.getHttpHeader(request, \"ce-signature\"),\n    userId: utils.getHttpHeader(request, \"ce-userid\"),\n    hub: utils.getHttpHeader(request, \"ce-hub\")!,\n    connectionId: utils.getHttpHeader(request, \"ce-connectionid\")!,\n    eventName: utils.getHttpHeader(request, \"ce-eventname\")!,\n    origin: origin,\n    states: utils.fromBase64JsonString(utils.getHttpHeader(request, \"ce-connectionstate\")),\n  };\n\n  // TODO: validation\n  return context;\n}\n\nfunction tryGetWebPubSubEvent(req: IncomingMessage): EventType | undefined {\n  // check ce-type to see if it is a valid WebPubSub CloudEvent request\n  const prefix = \"azure.webpubsub.\";\n  const connect = \"azure.webpubsub.sys.connect\";\n  const connected = \"azure.webpubsub.sys.connected\";\n  const disconnectd = \"azure.webpubsub.sys.disconnected\";\n  const userPrefix = \"azure.webpubsub.user.\";\n  const type = utils.getHttpHeader(req, \"ce-type\");\n  if (!type?.startsWith(prefix)) {\n    return undefined;\n  }\n  if (type.startsWith(userPrefix)) {\n    return EventType.UserEvent;\n  }\n  switch (type) {\n    case connect:\n      return EventType.Connect;\n    case connected:\n      return EventType.Connected;\n    case disconnectd:\n      return EventType.Disconnected;\n    default:\n      return undefined;\n  }\n}\n\nfunction isWebPubSubRequest(req: IncomingMessage): boolean {\n  return utils.getHttpHeader(req, \"ce-awpsversion\") !== undefined;\n}\n\nasync function readUserEventRequest(\n  request: IncomingMessage,\n  origin: string\n): Promise<UserEventRequest | undefined> {\n  const contentTypeheader = utils.getHttpHeader(request, \"content-type\");\n  if (contentTypeheader === undefined) {\n    return undefined;\n  }\n\n  const contentType = contentTypeheader.split(\";\")[0].trim();\n\n  switch (contentType) {\n    case \"application/octet-stream\":\n      return {\n        context: getContext(request, origin),\n        data: await utils.readRequestBody(request),\n        dataType: \"binary\",\n      };\n    case \"application/json\":\n      return {\n        context: getContext(request, origin),\n        data: JSON.parse((await utils.readRequestBody(request)).toString()),\n        dataType: \"json\",\n      };\n    case \"text/plain\":\n      return {\n        context: getContext(request, origin),\n        data: (await utils.readRequestBody(request)).toString(),\n        dataType: \"text\",\n      };\n    default:\n      return undefined;\n  }\n}\n\nasync function readSystemEventRequest<T extends { context: ConnectionContext }>(\n  request: IncomingMessage,\n  origin: string\n): Promise<T> {\n  const body = (await utils.readRequestBody(request)).toString();\n  const parsedRequest = JSON.parse(body) as T;\n  parsedRequest.context = getContext(request, origin);\n  return parsedRequest;\n}\n\n/**\n * @internal\n */\nexport class CloudEventsDispatcher {\n  private readonly _allowAll: boolean = true;\n  private readonly _allowedOrigins: Array<string> = [];\n  constructor(private hub: string, private eventHandler?: WebPubSubEventHandlerOptions) {\n    if (Array.isArray(eventHandler)) {\n      throw new Error(\"Unexpected WebPubSubEventHandlerOptions\");\n    }\n    if (eventHandler?.allowedEndpoints !== undefined) {\n      this._allowedOrigins = eventHandler.allowedEndpoints.map((endpoint) =>\n        new URL(endpoint).host.toLowerCase()\n      );\n      this._allowAll = false;\n    }\n  }\n\n  public handlePreflight(req: IncomingMessage, res: ServerResponse): boolean {\n    if (!isWebPubSubRequest(req)) {\n      return false;\n    }\n    const origin = utils.getHttpHeader(req, \"webhook-request-origin\");\n\n    if (origin === undefined) {\n      logger.warning(\"Expecting webhook-request-origin header.\");\n      res.statusCode = 400;\n    } else if (this._allowAll) {\n      res.setHeader(\"WebHook-Allowed-Origin\", \"*\");\n    } else {\n      // service to do the check\n      res.setHeader(\"WebHook-Allowed-Origin\", this._allowedOrigins);\n    }\n\n    res.end();\n    return true;\n  }\n\n  public async handleRequest(request: IncomingMessage, response: ServerResponse): Promise<boolean> {\n    if (!isWebPubSubRequest(request)) {\n      return false;\n    }\n\n    // check if it is a valid WebPubSub cloud events\n    const origin = utils.getHttpHeader(request, \"webhook-request-origin\");\n    if (origin === undefined) {\n      return false;\n    }\n\n    const eventType = tryGetWebPubSubEvent(request);\n    if (eventType === undefined) {\n      return false;\n    }\n\n    // check if hub matches\n    const hub = utils.getHttpHeader(request, \"ce-hub\");\n    if (hub?.toUpperCase() !== this.hub.toUpperCase()) {\n      return false;\n    }\n\n    // No need to read body if handler is not specified\n    switch (eventType) {\n      case EventType.Connect:\n        if (!this.eventHandler?.handleConnect) {\n          response.end();\n          return true;\n        }\n        break;\n      case EventType.Connected:\n        if (!this.eventHandler?.onConnected) {\n          response.end();\n          return true;\n        }\n        break;\n      case EventType.Disconnected:\n        if (!this.eventHandler?.onDisconnected) {\n          response.end();\n          return true;\n        }\n        break;\n      case EventType.UserEvent:\n        if (!this.eventHandler?.handleUserEvent) {\n          response.end();\n          return true;\n        }\n        break;\n      default:\n        logger.warning(`Unknown EventType ${eventType}`);\n        return false;\n    }\n\n    switch (eventType) {\n      case EventType.Connect: {\n        const connectRequest = await readSystemEventRequest<ConnectRequest>(request, origin);\n        // service passes out query property, assign it to queries\n        connectRequest.queries = connectRequest.query;\n        logger.verbose(connectRequest);\n\n        this.eventHandler.handleConnect!(\n          connectRequest,\n          getConnectResponseHandler(connectRequest, response)\n        );\n        return true;\n      }\n      case EventType.Connected: {\n        // for unblocking events, we responds to the service as early as possible\n        response.end();\n        const connectedRequest = await readSystemEventRequest<ConnectedRequest>(request, origin);\n        logger.verbose(connectedRequest);\n        this.eventHandler.onConnected!(connectedRequest);\n        return true;\n      }\n      case EventType.Disconnected: {\n        // for unblocking events, we responds to the service as early as possible\n        response.end();\n        const disconnectedRequest = await readSystemEventRequest<DisconnectedRequest>(\n          request,\n          origin\n        );\n        logger.verbose(disconnectedRequest);\n        this.eventHandler.onDisconnected!(disconnectedRequest);\n        return true;\n      }\n      case EventType.UserEvent: {\n        const userRequest = await readUserEventRequest(request, origin);\n        if (userRequest === undefined) {\n          logger.warning(\n            `Unsupported content type ${utils.getHttpHeader(request, \"content-type\")}`\n          );\n          return false;\n        }\n        logger.verbose(userRequest);\n        this.eventHandler.handleUserEvent!(\n          userRequest,\n          getUserEventResponseHandler(userRequest, response)\n        );\n        return true;\n      }\n      default:\n        logger.warning(`Unknown EventType ${eventType}`);\n        return false;\n    }\n  }\n}\n","// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n\nimport express from \"express-serve-static-core\";\n\nimport { CloudEventsDispatcher } from \"./cloudEventsDispatcher\";\nimport { WebPubSubEventHandlerOptions } from \"./cloudEventsProtocols\";\n\n/**\n * The handler to handle incoming CloudEvents messages\n */\nexport class WebPubSubEventHandler {\n  /**\n   * The path this CloudEvents handler listens to\n   */\n  public readonly path: string;\n\n  private _cloudEventsHandler: CloudEventsDispatcher;\n\n  /**\n   * Creates an instance of a WebPubSubEventHandler for handling incoming CloudEvents messages.\n   *\n   * Example usage:\n   * ```ts\n   * import express from \"express\";\n   * import { WebPubSubEventHandler } from \"@azure/web-pubsub-express\";\n   * const endpoint = \"https://xxxx.webpubsubdev.azure.com\"\n   * const handler = new WebPubSubEventHandler('chat', {\n   *   handleConnect: (req, res) => {\n   *     console.log(JSON.stringify(req));\n   *     return {};\n   *   },\n   *   onConnected: req => {\n   *     console.log(JSON.stringify(req));\n   *   },\n   *   handleUserEvent: (req, res) => {\n   *     console.log(JSON.stringify(req));\n   *     res.success(\"Hey \" + req.data, req.dataType);\n   *    };\n   *   allowedEndpoints: [ endpoint ]\n   *  },\n   * });\n   * ```\n   *\n   * @param hub - The name of the hub to listen to\n   * @param options - Options to configure the event handler\n   */\n  constructor(private hub: string, options?: WebPubSubEventHandlerOptions) {\n    const path = (options?.path ?? `/api/webpubsub/hubs/${hub}/`).toLowerCase();\n    this.path = path.endsWith(\"/\") ? path : path + \"/\";\n    this._cloudEventsHandler = new CloudEventsDispatcher(this.hub, options);\n  }\n\n  /**\n   * Get the middleware to process the CloudEvents requests\n   */\n  public getMiddleware(): express.RequestHandler {\n    return async (\n      req: express.Request,\n      res: express.Response,\n      next: express.NextFunction\n    ): Promise<void> => {\n      // Request originalUrl can contain query while baseUrl + path not\n      let requestUrl = (req.baseUrl + req.path).toLowerCase();\n\n      // normalize the Url\n      requestUrl = requestUrl.endsWith(\"/\") ? requestUrl : requestUrl + \"/\";\n      if (requestUrl.startsWith(this.path)) {\n        if (req.method === \"OPTIONS\") {\n          if (this._cloudEventsHandler.handlePreflight(req, res)) {\n            return;\n          }\n        } else if (req.method === \"POST\") {\n          try {\n            if (await this._cloudEventsHandler.handleRequest(req, res)) {\n              return;\n            }\n          } catch (err: any) {\n            next(err);\n            return;\n          }\n        }\n      }\n\n      next();\n    };\n  }\n}\n"],"names":["createClientLogger","utils.toBase64JsonString","utils.getHttpHeader","utils.fromBase64JsonString","utils.readRequestBody","URL"],"mappings":"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"}