{"version":3,"file":"groups.spec.js","sourceRoot":"","sources":["../../test/groups.spec.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation.\n// Licensed under the MIT license.\n/* eslint-disable no-invalid-this */\nimport { Recorder, assertEnvironmentVariable } from \"@azure-tools/test-recorder\";\nimport { WebPubSubServiceClient, WebPubSubGroup } from \"../src\";\nimport { assert } from \"chai\";\nimport recorderOptions from \"./testEnv\";\nimport { FullOperationResponse } from \"@azure/core-client\";\nimport { RestError } from \"@azure/core-rest-pipeline\";\n/* eslint-disable @typescript-eslint/no-invalid-this */\n\ndescribe(\"Group client working with a group\", function () {\n  let recorder: Recorder;\n  let client: WebPubSubGroup;\n  let lastResponse: FullOperationResponse | undefined;\n  function onResponse(response: FullOperationResponse) {\n    lastResponse = response;\n  }\n  beforeEach(async function () {\n    recorder = new Recorder(this.currentTest);\n    await recorder.start(recorderOptions);\n    const hubClient = new WebPubSubServiceClient(\n      assertEnvironmentVariable(\"WPS_CONNECTION_STRING\"),\n      \"simplechat\",\n      recorder.configureClientOptions({})\n    );\n\n    client = hubClient.group(\"group\");\n  });\n\n  it(\"can broadcast to groups\", async () => {\n    await client.sendToAll(\"hello\", { contentType: \"text/plain\", onResponse });\n    assert.equal(lastResponse?.status, 202);\n\n    await client.sendToAll({ x: 1, y: 2 }, { onResponse });\n    assert.equal(lastResponse?.status, 202);\n\n    const binaryMessage = new Uint8Array(10);\n    await client.sendToAll(binaryMessage.buffer, { onResponse });\n    assert.equal(lastResponse?.status, 202);\n  });\n\n  it(\"can broadcast to group with filter\", async () => {\n    await client.sendToAll(\"hello\", {\n      contentType: \"text/plain\",\n      filter: \"userId ne 'user1'\",\n      onResponse,\n    });\n    assert.equal(lastResponse?.status, 202);\n\n    let error;\n    try {\n      await client.sendToAll(\"hello\", {\n        contentType: \"text/plain\",\n        filter: \"invalid filter\",\n      });\n    } catch (e: any) {\n      if (e.name !== \"RestError\") {\n        throw e;\n      }\n\n      error = e;\n    }\n    assert.equal(error.statusCode, 400);\n    assert.equal(\n      JSON.parse(error.message).message,\n      \"Invalid syntax for 'invalid filter': Syntax error at position 14 in 'invalid filter'. (Parameter 'filter')\"\n    );\n  });\n\n  it(\"can manage connections\", async () => {\n    // this endpoint returns 404 for connections not on the hub\n    let error: RestError | undefined;\n    try {\n      await client.addConnection(\"xxxx\");\n    } catch (e: any) {\n      error = e;\n    }\n\n    assert.exists(error);\n    assert.strictEqual(error?.name, \"RestError\");\n\n    try {\n      await client.removeConnection(\"xxxx\", { onResponse });\n    } catch (e: any) {\n      assert.exists(error);\n      assert.strictEqual(error?.name, \"RestError\");\n    }\n  });\n\n  // skipping until we can record better tests with an actual user active.\n  it.skip(\"can manage users\", async () => {\n    // service returns 404, this should likely be raised as an error but isn't\n    // due to the swagger design\n    await client.addUser(\"brian\");\n\n    // service returns 404 and this throws.\n    await client.removeUser(\"brian\");\n  });\n\n  afterEach(async function () {\n    await recorder.stop();\n  });\n});\n"]}